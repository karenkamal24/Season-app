# نظام إرسال التذكيرات التلقائي

## نظرة عامة
بعد حفظ التذكير في قاعدة البيانات، يتم إرسال إشعارات push تلقائياً في الوقت المحدد.

## كيف يعمل النظام؟

### 1. عند إنشاء تذكير جديد
- المستخدم ينشئ تذكير عبر API endpoint: `POST /api/reminders`
- التذكير يُحفظ في قاعدة البيانات مع:
  - التاريخ والوقت المحدد
  - نوع التكرار (once, daily, weekly, monthly)
  - Timezone المستخدم

### 2. التحقق التلقائي من التذكيرات
- يتم تشغيل Command تلقائياً **كل دقيقة** للتحقق من التذكيرات المستحقة
- Command: `reminders:send`
- الموجود في: `app/Console/Commands/SendReminders.php`

### 3. منطق الإرسال

#### للتذكيرات لمرة واحدة (`once`):
- يتم الإرسال عندما يكون الوقت الحالي >= وقت التذكير المحدد
- نافذة التسامح: 5 دقائق
- بعد الإرسال، يتم تغيير حالة التذكير إلى `completed`

#### للتذكيرات اليومية (`daily`):
- يتم الإرسال كل يوم في نفس الوقت المحدد
- يتم التحقق من عدم إرسال التذكير في نفس اليوم (للمنع التكرار)

#### للتذكيرات الأسبوعية (`weekly`):
- يتم الإرسال كل أسبوع في نفس اليوم والوقت
- يتم التحقق من عدم إرسال التذكير في نفس الأسبوع

#### للتذكيرات الشهرية (`monthly`):
- يتم الإرسال كل شهر في نفس اليوم والوقت
- يتم التحقق من عدم إرسال التذكير في نفس الشهر

### 4. إرسال الإشعارات
- يتم استخدام Firebase Cloud Messaging (FCM) لإرسال الإشعارات
- الإشعارات تُرسل بناءً على `fcm_token` الخاص بالمستخدم
- يتم إرسال العنوان والرسالة باللغة المفضلة للمستخدم (ar/en)

## إعداد Cron Job

يجب إعداد Cron Job على السيرفر لتشغيل الـ scheduler:

```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

أو على Windows (Task Scheduler):
- قم بإنشاء مهمة مجدولة لتشغيل `php artisan schedule:run` كل دقيقة

## اختبار النظام

### اختبار يدوي:
```bash
php artisan reminders:send
```

### إنشاء تذكير تجريبي:
1. استخدم API endpoint: `POST /api/reminders`
2. حدد وقت في دقائق قليلة من الآن
3. انتظر دقيقة واحدة
4. يجب أن تتلقى إشعار push

## الحقول المضافة

تم إضافة حقل `last_sent_at` في جدول `reminders` لتتبع آخر مرة تم فيها إرسال التذكير (للتذكيرات المتكررة).

## ملاحظات مهمة

1. **FCM Token مطلوب**: لن يتم إرسال الإشعارات إذا لم يكن لدى المستخدم `fcm_token`
2. **Timezone**: النظام يحترم timezone المحدد في التذكير
3. **نافذة التسامح**: 5 دقائق لتجنب مشاكل التوقيت
4. **Queue**: الإشعارات تُرسل عبر Queue (يجب أن يكون queue worker قيد التشغيل)

