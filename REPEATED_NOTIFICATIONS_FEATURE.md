# ๐ ููุฒุฉ ุงูุฅุดุนุงุฑุงุช ุงููุชูุฑุฑุฉ ููุฃุนุถุงุก ุฎุงุฑุฌ ุงููุทุงู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ูุธุงู ุงูุฅุดุนุงุฑุงุช ููุฑุณู ุชูุจููุงุช ูุชูุฑุฑุฉ ูู **ุฏูููุชูู** ููุฃุนุถุงุก ุงูุฐูู ูููููู ุฎุงุฑุฌ ูุทุงู ุงูุฃูุงูุ ูุน ุฅููุงู ุงูุฅุดุนุงุฑุงุช ุชููุงุฆูุงู ุนูุฏ ุนูุฏุชูู ุฏุงุฎู ุงููุทุงู.

---

## โจ ููู ูุนูู ุงููุธุงู

### ๐ด ุนุถู ุฎุงุฑุฌ ุงููุทุงู
```
1. ุงูุนุถู ูุฎุฑุฌ ูู ูุทุงู ุงูุฃูุงู (> safety_radius ูู ุงููุงูู)
2. ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฑู ูุฌููุน ุงูุฃุนุถุงุก
3. ุจุนุฏ ุฏูููุชูู โ ุฅุดุนุงุฑ ุขุฎุฑ
4. ุจุนุฏ ุฏูููุชูู โ ุฅุดุนุงุฑ ุขุฎุฑ
5. ... ูููุฐุง ูู ุฏูููุชูู ุทุงููุง ุงูุนุถู ุฎุงุฑุฌ ุงููุทุงู
```

### ๐ข ุนุถู ูุนูุฏ ุฏุงุฎู ุงููุทุงู
```
1. ุงูุนุถู ูุนูุฏ ุฏุงุฎู ุงููุทุงู (<= safety_radius ูู ุงููุงูู)
2. ุฅููุงู ุงูุฅุดุนุงุฑุงุช ููุฑุงู โ
3. ูุง ูุฒูุฏ ูู ุงูุฅุดุนุงุฑุงุช ุญุชู ูุฎุฑุฌ ูุฑุฉ ุฃุฎุฑู
```

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช

**Migration:** `2025_10_28_185024_add_last_notification_sent_at_to_group_members_table.php`

ุชู ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ ูู ุฌุฏูู `group_members`:

```sql
last_notification_sent_at TIMESTAMP NULL
```

**ุงูุบุฑุถ:**
- ุชุชุจุน ุขุฎุฑ ููุช ุชู ููู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนุถู
- ุญุณุงุจ ูุง ุฅุฐุง ูุฑ ุฏูููุชุงู ุฃู ุฃูุซุฑ ููุฐ ุขุฎุฑ ุฅุดุนุงุฑ

---

### 2. Model: GroupMember

ุชู ุชุญุฏูุซ Model ูุฅุถุงูุฉ ุงูุญูู ุงูุฌุฏูุฏ:

```php
protected $fillable = [
    // ... existing fields
    'last_notification_sent_at',
];

protected $casts = [
    // ... existing casts
    'last_notification_sent_at' => 'datetime',
];
```

---

### 3. Service: GroupService

#### Method: `updateLocation()`

**ุงูููุทู ุงูุฌุฏูุฏ:**

```php
// ุฅุฐุง ูุงู ุงูุนุถู ุฎุงุฑุฌ ุงููุทุงู
if (!$isWithinRadius && $group->notifications_enabled) {
    $shouldSendNotification = false;
    
    // ุงูุชุญูู: ูู ูุฐู ุฃูู ูุฑุฉ ุฃู ูุฑ ุฏูููุชุงูุ
    if ($member->last_notification_sent_at === null) {
        // ุฃูู ูุฑุฉ ุฎุงุฑุฌ ุงููุทุงู
        $shouldSendNotification = true;
    } else {
        // ุญุณุงุจ ุงูุฏูุงุฆู ููุฐ ุขุฎุฑ ุฅุดุนุงุฑ
        $minutesSinceLastNotification = now()->diffInMinutes($member->last_notification_sent_at);
        if ($minutesSinceLastNotification >= 2) {
            $shouldSendNotification = true;
        }
    }
    
    if ($shouldSendNotification) {
        $this->sendOutOfRangeNotification($group, $member->user, $distance);
        $updateData['last_notification_sent_at'] = now();
    }
}
// ุฅุฐุง ุนุงุฏ ุงูุนุถู ุฏุงุฎู ุงููุทุงู
else if ($isWithinRadius && $member->last_notification_sent_at !== null) {
    // ุฅููุงู ุงูุฅุดุนุงุฑุงุช
    $updateData['last_notification_sent_at'] = null;
}
```

---

#### Method: `sendOutOfRangeNotification()`

ุชู ุชุญุฏูุซ ุงูุฅุดุนุงุฑ ููุชุถูู ุงููุณุงูุฉ ุงูุญุงููุฉ:

**ุงูุฅุดุนุงุฑ ุงูุฌุฏูุฏ:**
```json
{
  "title": "ุชูุจูู: ุนุถู ุฎุงุฑุฌ ุงููุทุงู",
  "body": "ูุญูุฏ ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 150ูุชุฑ (ุงููุทุงู ุงูุขูู: 100ูุชุฑ)",
  "data": {
    "type": "out_of_range",
    "group_id": "1",
    "user_id": "2",
    "user_name": "ูุญูุฏ",
    "distance": "150",
    "safety_radius": "100"
  }
}
```

---

## ๐ ุณููุงุฑูู ูุงูู

### ูุซุงู: ุทูู ูุถูุน ูู ูุฑูุฒ ุชุฌุงุฑู

#### ุงูููุช 14:00
```
โ ุงูุฃุจ (ุงููุงูู) ูููุนู: (25.2048, 55.2708)
โ ุงูุทูู ูููุนู: (25.2048, 55.2708)
๐ ุงููุณุงูุฉ: 0 ูุชุฑ
๐ข ุฏุงุฎู ุงููุทุงู
```

#### ุงูููุช 14:05
```
โ ุงูุฃุจ ูููุนู: (25.2048, 55.2708) - ูู ูุชุญุฑู
โ ุงูุทูู ูููุนู: (25.2150, 55.2800)
๐ ุงููุณุงูุฉ: 150 ูุชุฑ
๐ด ุฎุงุฑุฌ ุงููุทุงู!
๐ฑ ุฅุดุนุงุฑ ููุฑู: "ุงูุทูู ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 150ูุชุฑ"
โฐ last_notification_sent_at = 14:05
```

#### ุงูููุช 14:06
```
โ ุงูุทูู ูููุนู: (25.2160, 55.2810)
๐ ุงููุณุงูุฉ: 180 ูุชุฑ
๐ด ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู
โธ๏ธ ูู ููุฑ ุฏูููุชุงู - ูุง ุฅุดุนุงุฑ
```

#### ุงูููุช 14:07
```
โ ุงูุทูู ูููุนู: (25.2170, 55.2820)
๐ ุงููุณุงูุฉ: 200 ูุชุฑ
๐ด ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู
๐ฑ ุฅุดุนุงุฑ ุฌุฏูุฏ: "ุงูุทูู ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 200ูุชุฑ"
โฐ last_notification_sent_at = 14:07
```

#### ุงูููุช 14:09
```
โ ุงูุทูู ูููุนู: (25.2180, 55.2830)
๐ ุงููุณุงูุฉ: 220 ูุชุฑ
๐ด ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู
๐ฑ ุฅุดุนุงุฑ ุฌุฏูุฏ: "ุงูุทูู ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 220ูุชุฑ"
โฐ last_notification_sent_at = 14:09
```

#### ุงูููุช 14:10
```
โ ุงูุทูู ุนุงุฏ ูููุนู: (25.2050, 55.2710)
๐ ุงููุณุงูุฉ: 50 ูุชุฑ
๐ข ุนุงุฏ ุฏุงุฎู ุงููุทุงู!
โ ุฅููุงู ุงูุฅุดุนุงุฑุงุช
โฐ last_notification_sent_at = null
```

---

## ๐ฏ ุงูููุงุฆุฏ

| ุงูููุฒุฉ | ุงููุงุฆุฏุฉ |
|--------|---------|
| ๐ **ุฅุดุนุงุฑุงุช ูุชูุฑุฑุฉ** | ุชุฐููุฑ ูุณุชูุฑ ุจุฃู ุงูุนุถู ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู |
| โฑ๏ธ **ูู ุฏูููุชูู** | ุชูุงุฒู ุจูู ุงูุชูุจูู ุงููุณุชูุฑ ูุนุฏู ุงูุฅุฒุนุงุฌ ุงูุฒุงุฆุฏ |
| ๐ **ุนุฑุถ ุงููุณุงูุฉ** | ูุนุฑูุฉ ูุฏู ุจูุนุฏ ุงูุนุถู ุนู ุงููุงูู |
| ๐ **ุฅููุงู ุชููุงุฆู** | ุชููู ุงูุฅุดุนุงุฑุงุช ููุฑุงู ุนูุฏ ุงูุนูุฏุฉ |
| ๐ **ุชูููุฑ ุงูููุงุฑุฏ** | ุนุฏู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุบูุฑ ุถุฑูุฑูุฉ |

---

## ๐ฑ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

### ูู ุงูุชุทุจูู Mobile

#### ุงูุฅุดุนุงุฑ ุงูุฃูู (ุฎุฑูุฌ ูู ุงููุทุงู)
```
๐ด ุชูุจูู: ุนุถู ุฎุงุฑุฌ ุงููุทุงู
ูุญูุฏ ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 150ูุชุฑ (ุงููุทุงู ุงูุขูู: 100ูุชุฑ)
[ุงุถุบุท ูุนุฑุถ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ]
```

#### ุงูุฅุดุนุงุฑ ุจุนุฏ ุฏูููุชูู (ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู)
```
๐ด ุชูุจูู: ุนุถู ุฎุงุฑุฌ ุงููุทุงู
ูุญูุฏ ุฎุงุฑุฌ ุงููุทุงู - ุงููุณุงูุฉ: 180ูุชุฑ (ุงููุทุงู ุงูุขูู: 100ูุชุฑ)
[ุงุถุบุท ูุนุฑุถ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ]
```

#### ุนูุฏ ุงูุนูุฏุฉ ุฏุงุฎู ุงููุทุงู
```
๐ข ูุญูุฏ ุนุงุฏ ุฏุงุฎู ุงููุทุงู
ุงููุณุงูุฉ ุงูุญุงููุฉ: 50ูุชุฑ
โ ูู ุดูุก ุขูู
```

---

## ๐ง ุฅุนุฏุงุฏุงุช ูุงุจูุฉ ููุชุฎุตูุต

### ุชุบููุฑ ูุชุฑุฉ ุงูุฅุดุนุงุฑุงุช (ุญุงููุงู: ุฏูููุชูู)

ูู `GroupService.php`:

```php
// ูุชุบููุฑ ุงููุชุฑุฉ ูู ุฏูููุชูู ุฅูู 3 ุฏูุงุฆู:
if ($minutesSinceLastNotification >= 3) {
    $shouldSendNotification = true;
}

// ููุฅุดุนุงุฑ ูู ุฏูููุฉ:
if ($minutesSinceLastNotification >= 1) {
    $shouldSendNotification = true;
}

// ููุฅุดุนุงุฑ ูู 5 ุฏูุงุฆู:
if ($minutesSinceLastNotification >= 5) {
    $shouldSendNotification = true;
}
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงูููุฒุฉ

### Test Case 1: ุฃูู ุฎุฑูุฌ ูู ุงููุทุงู

```bash
# 1. Owner updates location (center)
POST /api/groups/1/location
{
  "latitude": 25.2048,
  "longitude": 55.2708
}

# 2. Member goes out of range (first time)
POST /api/groups/1/location
{
  "latitude": 25.2150,
  "longitude": 55.2800
}

# Result:
# โ distance_from_center โ 150m
# โ is_within_radius = false
# โ Notification sent immediately
# โ last_notification_sent_at = now()
```

---

### Test Case 2: ูุง ุฒุงู ุฎุงุฑุฌ ุงููุทุงู (ูู ููุฑ ุฏูููุชุงู)

```bash
# After 1 minute, member updates location
POST /api/groups/1/location
{
  "latitude": 25.2160,
  "longitude": 55.2810
}

# Result:
# โ distance_from_center โ 180m
# โ is_within_radius = false
# โ No notification (only 1 minute passed)
# โธ๏ธ last_notification_sent_at = unchanged
```

---

### Test Case 3: ูุฑ ุฏูููุชุงู - ุฅุดุนุงุฑ ุฌุฏูุฏ

```bash
# After 2 minutes total, member updates location
POST /api/groups/1/location
{
  "latitude": 25.2170,
  "longitude": 55.2820
}

# Result:
# โ distance_from_center โ 200m
# โ is_within_radius = false
# โ Notification sent (2 minutes passed)
# โ last_notification_sent_at = now()
```

---

### Test Case 4: ุนูุฏุฉ ุฏุงุฎู ุงููุทุงู - ุฅููุงู ุงูุฅุดุนุงุฑุงุช

```bash
# Member comes back in range
POST /api/groups/1/location
{
  "latitude": 25.2050,
  "longitude": 55.2710
}

# Result:
# โ distance_from_center โ 50m
# โ is_within_radius = true
# โ last_notification_sent_at = null (reset)
# ๐ Notifications stopped
```

---

## ๐ Database Schema

### ุงูุญูู ุงูุฌุฏูุฏ ูู `group_members`

```sql
CREATE TABLE group_members (
    id BIGINT UNSIGNED PRIMARY KEY,
    group_id BIGINT UNSIGNED,
    user_id BIGINT UNSIGNED,
    role VARCHAR(255),
    status VARCHAR(255),
    is_within_radius BOOLEAN,
    out_of_range_count INT,
    joined_at TIMESTAMP,
    last_location_update TIMESTAMP,
    last_notification_sent_at TIMESTAMP NULL,  -- โญ ุฌุฏูุฏ
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅูุฌุงุฒู:

โ **ุฅุถุงูุฉ ุญูู `last_notification_sent_at`** ูู ุฌุฏูู `group_members`
โ **ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูุชูุฑุฑุฉ ูู ุฏูููุชูู** ููุฃุนุถุงุก ุฎุงุฑุฌ ุงููุทุงู
โ **ุฅููุงู ุงูุฅุดุนุงุฑุงุช ุชููุงุฆูุงู** ุนูุฏ ุนูุฏุฉ ุงูุนุถู ุฏุงุฎู ุงููุทุงู
โ **ุนุฑุถ ุงููุณุงูุฉ ุงูุญุงููุฉ** ูู ุงูุฅุดุนุงุฑ
โ **ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู** ูุน ุฅุดุนุงุฑุงุช ุฃูุซุฑ ูุนูููุงุชูุฉ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

```
โ database/migrations/2025_10_28_185024_add_last_notification_sent_at_to_group_members_table.php
โ app/Models/GroupMember.php
โ app/Services/GroupService.php
โ REPEATED_NOTIFICATIONS_FEATURE.md (ูุฐุง ุงูููู)
```

---

## ๐ก ูุตุงุฆุญ ููุงุณุชุฎุฏุงู ุงูุฃูุซู

### 1. ูู ุงูุชุทุจูู Mobile
- ุชุฃูุฏ ูู ุชุญุฏูุซ ุงููููุน ุจุดูู ููุชุธู (ูู 30-60 ุซุงููุฉ)
- ุงุนุฑุถ ุงูุฅุดุนุงุฑุงุช ุจุดูู ูุงุถุญ ูุน ุตูุช ุชูุจูู
- ุฃุถู ุฒุฑ ุณุฑูุน ููุงูุชูุงู ุฅูู ุงูุฎุฑูุทุฉ

### 2. ููุฃุฏุงุก
- ุงูุฅุดุนุงุฑุงุช ุชุฑุณู ููุท ุฅุฐุง `notifications_enabled = true`
- ูุง ุฅุดุนุงุฑุงุช ุฅุฐุง ูุงู ุงูุนุถู ุฏุงุฎู ุงููุทุงู
- ุงูุญุณุงุจ ูุชู ุนูุฏ ูู `updateLocation()` ููุท

### 3. ููุชุฎุตูุต
- ูููู ุชุบููุฑ ุงููุชุฑุฉ (ุญุงููุงู 2 ุฏูููุฉ) ุญุณุจ ุงูุญุงุฌุฉ
- ูููู ุชุฎุตูุต ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ
- ูููู ุฅุถุงูุฉ ุตูุช ุฃู ุงูุชุฒุงุฒ ูุฎุชูู ููุฅุดุนุงุฑุงุช ุงููุชูุฑุฑุฉ

---

**โจ ุงูููุฒุฉ ุฌุงูุฒุฉ ูููุนููุฉ! โจ**

ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 28 ุฃูุชูุจุฑ 2025

